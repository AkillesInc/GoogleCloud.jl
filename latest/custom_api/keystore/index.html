<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Key Store - GoogleCloud.jl</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../assets/Documenter.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Key Store";
    var mkdocs_page_input_path = "custom_api/keystore.md";
    var mkdocs_page_url = "/custom_api/keystore/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="../../assets/mathjaxhelper.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> GoogleCloud.jl</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Custom APIs</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../">Collections</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Key Store</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#key-value-store">Key-Value Store</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>API Documentation</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../api/credentials/">Credentials</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../api/session/">Sessions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../api/api/">API Representation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../api/root/">API Root URLs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../api/error/">Error Types</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">GoogleCloud.jl</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Custom APIs &raquo;</li>
        
      
    
    <li>Key Store</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/joshbode/GoogleCloud.jl" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a id='Key-Value-Store-1'></a></p>
<h1 id="key-value-store">Key-Value Store</h1>
<p>The <code>KeyStore</code> API is a custom key-value API built on the object storage API. That is, it is not an API offered by the Google Cloud Platform. It is intended to be used to store key-value pairs. Below is a brief tutorial that walks through some typical usage of the <code>KeyStore</code> API.</p>
<p>First, load the package.</p>
<pre><code class="julia">using GoogleCloud
session = GoogleSession(expanduser(&quot;~/credentials.json&quot;), [&quot;devstorage.full_control&quot;])
</code></pre>

<p>Define a function for serializing data to Vector{UInt8} before writing to the key-value store. Also define a corresponding deserializer, which is called when reading from the store. </p>
<pre><code class="julia">function serialize_to_uint8_vector(x)
    io = IOBuffer()
    serialize(io, x)
    takebuf_array(io)
end

deserialize_from_vector(x) = deserialize(IOBuffer(x))
</code></pre>

<p>Initialize the key-value store. In this case our store uses the default options, which synchronizes the data in the remote store with the data in the local store.</p>
<pre><code class="julia">kv_sync = KeyStore{Int, Int}(
    &quot;kvtest&quot;;                                  # Key-value store name. Created if it doesn't already exist.
    session    = session,
    val_writer = serialize_to_uint8_vector,    # Function for serializing data before writing to the store
    val_reader = deserialize_from_vector,      # Function for deserializing data before reading from the store 
    use_remote = true,                         # Defaults to true. Commit every write to the remote store.
    use_cache  = true,                         # Defaults to true. Commit every write to the local store.
    reset      = false                         # Defaults to false. Empty the bucket if it exists.
)
</code></pre>

<p>Note that <code>use_remote</code> and <code>use_cache</code> can't both be <code>false</code>. An error is raised if this occurs.</p>
<p>Run some basic get/set methods, verifying their effects along the way.</p>
<pre><code class="julia"># Get the data from the key-value store. Currently there is no data.
keys(kv_sync)       # Returns array of keys
values(kv_sync)     # Returns array of values
collect(kv_sync)    # Returns array of Pair(key, value)

# Write key-value pairs both locally (determined by use_cache = true) and remotely (determined by use_remote = true)
kv_sync[1] = 11
kv_sync[2] = 22

# Verify local store
kv_sync.cache

# Verify remote store
clearcache!(kv_sync)    # Clear local store
kv_sync.cache           # Verify local store is empty again
collect(kv_sync)        # Pull data from remote store and populate local store
kv_sync.cache           # Local store now contains our data
</code></pre>

<p>If you are writing frequently then the latency of persisting each write to the remote store may be unacceptably slow. One solution is to do all your writes locally, then persist them remotely with one <code>commit</code>, as follows:</p>
<pre><code class="julia">kv_local = KeyStore{Int, Int}(
    &quot;kvtest&quot;;                                  # The store name is the same as before.
    session    = session,                      # As before
    val_writer = serialize_to_uint8_vector,    # As before
    val_reader = deserialize_from_vector,      # As before
    use_remote = false                         # Work locally only, then manually sync with the remote store.
)

kv_local.cache        # Empty because kv_local is not synchronized with the remote store (because use_remote is false)
collect(kv_local)     # Empty because use_remote is false, so collect(kv_local) only looks at kv_local.cache
fetch!(kv_local)      # Manually fetch the data in the remote store
collect(kv_local)     # Local store is now populated
kv_local[3] = 33      # Writes to local store only
kv_sync[3]            # Error because key 3 hasn't been committed from kv_local to remote store
kv_local.pending      # List of changes made locally that have not been committed to the remote store
commit!(kv_local)     # Commit the local changes to the remote store
kv_local.pending      # The list of pending changes is now empty
kv_sync[3]            # Now returns 33 from the remote store
</code></pre>

<p>Finally we clean up.</p>
<pre><code class="julia">delete!(kv_sync)      # Error: Can't delete a non-empty remote store
reset!(kv_sync)       # Remove all data from remote store. Alternatively, delete!(kv_sync, 1), delete!(kv_sync, 2), etc.
delete!(kv_sync)      # Detaches local store from remote store and deletes remote store
</code></pre>

<p>Additional methods include:</p>
<pre><code class="julia">clearpending!(kvstore)    # Empty the list of local changes that haven't been committed to the remote store
sync!(kvstore)            # Commit local changes to remote store, then fetch data from remote store
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../api/credentials/" class="btn btn-neutral float-right" title="Credentials">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../" class="btn btn-neutral" title="Collections"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/joshbode/GoogleCloud.jl" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../api/credentials/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
